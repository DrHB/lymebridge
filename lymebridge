#!/bin/bash
set -e

VERSION="0.7.1"
CONFIG_FILE="$HOME/.config/lymebridge/config.json"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m'

show_help() {
    cat << EOF
lymebridge v$VERSION - Bridge Telegram to Claude Code

Usage:
  lymebridge setup            Configure Telegram bot
  lymebridge bridge [session] Bridge Telegram to tmux (current pane or named session)
  lymebridge version          Show version
  lymebridge help             Show this help

Quick start:
  1. lymebridge setup
  2. Start Claude Code in tmux: tmux new -s claude && claude
  3. From any terminal: lymebridge bridge claude
  4. Send messages via Telegram!
EOF
}

check_deps() {
    for cmd in curl jq tmux; do
        if ! command -v $cmd &> /dev/null; then
            echo -e "${RED}Error: $cmd is required but not installed${NC}"
            exit 1
        fi
    done
}

send_telegram() {
    local text="$1"
    curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
        -d "chat_id=${CHAT_ID}" \
        -d "text=${text}" > /dev/null 2>&1
}

# Monitor tmux output and send to Telegram
monitor_output() {
    local target="$1"
    local last_hash=""
    local TMPFILE="/tmp/lymebridge_capture_$$"

    trap "rm -f $TMPFILE" EXIT

    while true; do
        sleep 2

        # Capture pane with history, strip ANSI codes
        # Also normalize NO-BREAK SPACE (U+00A0) to regular space
        tmux capture-pane -t "$target" -p -S -500 2>/dev/null | \
            sed 's/\x1b\[[0-9;]*m//g' | \
            sed $'s/\xc2\xa0/ /g' > "$TMPFILE"

        [[ ! -s "$TMPFILE" ]] && continue

        # Simple approach: find the LAST response block
        # Response = everything between last ⏺ line and next ❯ line (or end)
        local response
        response=$(awk '
            /^⏺ / {
                in_response = 1
                buf = substr($0, 4)
                next
            }
            /^❯ / {
                if (in_response) {
                    last_response = buf
                    in_response = 0
                    buf = ""
                }
                next
            }
            in_response {
                buf = buf "\n" $0
            }
            END {
                if (in_response) {
                    if (length(buf) > 0) print buf
                } else {
                    if (length(last_response) > 0) print last_response
                }
            }
        ' "$TMPFILE")

        # Clean up: remove UI elements and box-drawing
        response=$(printf '%s' "$response" | \
            grep -v '? for shortcuts' | \
            grep -v 'esc to interrupt' | \
            grep -v '^─*$' | \
            sed 's/^[[:space:]]*$//' | \
            head -100)

        # Remove leading/trailing blank lines
        response=$(printf '%s' "$response" | sed '/./,$!d' | sed ':a;/^[[:space:]]*$/{ $d;N;ba;}')

        [[ -z "$response" ]] && continue

        # Wait for response to stabilize (Claude still typing?)
        sleep 1
        local hash_before
        hash_before=$(tmux capture-pane -t "$target" -p -S -50 2>/dev/null | md5 2>/dev/null || echo "x")
        sleep 1
        local hash_after
        hash_after=$(tmux capture-pane -t "$target" -p -S -50 2>/dev/null | md5 2>/dev/null || echo "y")
        [[ "$hash_before" != "$hash_after" ]] && continue

        # Hash response to detect changes
        local hash
        hash=$(printf '%s' "$response" | md5 2>/dev/null || printf '%s' "$response" | md5sum | cut -d' ' -f1)

        if [[ "$hash" != "$last_hash" ]]; then
            local msg="${response:0:4000}"
            send_telegram "$msg"
            echo -e "${GREEN}[sent to telegram]${NC} ${msg:0:50}..."
            last_hash="$hash"
        fi
    done
}

run_setup() {
    echo ""
    echo "═══════════════════════════════════════"
    echo "         lymebridge setup"
    echo "═══════════════════════════════════════"
    echo ""
    echo "Step 1: Create a Telegram bot"
    echo "  1. Open Telegram and message @BotFather"
    echo "  2. Send /newbot and follow the prompts"
    echo "  3. Copy the bot token"
    echo ""
    read -p "Enter your bot token: " BOT_TOKEN

    if [[ -z "$BOT_TOKEN" ]]; then
        echo -e "${RED}Error: Bot token required${NC}"
        exit 1
    fi

    echo ""
    echo -e "${GREEN}✓ Token received${NC}"
    echo ""
    echo "Step 2: Link your Telegram account"
    echo "  Open Telegram and send any message to your bot."
    echo ""
    echo -n "Waiting for your message"

    CHAT_ID=""
    TIMEOUT=120
    START=$(date +%s)

    while [[ -z "$CHAT_ID" ]]; do
        NOW=$(date +%s)
        ELAPSED=$((NOW - START))
        if [[ $ELAPSED -gt $TIMEOUT ]]; then
            echo ""
            echo -e "${RED}Timeout waiting for message${NC}"
            exit 1
        fi

        echo -n "."
        RESPONSE=$(curl -s "https://api.telegram.org/bot${BOT_TOKEN}/getUpdates?timeout=1")
        CHAT_ID=$(echo "$RESPONSE" | jq -r '.result[-1].message.chat.id // empty')

        if [[ -z "$CHAT_ID" ]]; then
            sleep 2
        fi
    done

    echo " found!"
    echo ""
    echo -e "${GREEN}✓ Chat ID: $CHAT_ID${NC}"

    mkdir -p "$(dirname "$CONFIG_FILE")"
    cat > "$CONFIG_FILE" << EOF
{
  "botToken": "$BOT_TOKEN",
  "chatId": "$CHAT_ID"
}
EOF

    echo -e "${GREEN}✓ Config saved${NC}"
    echo ""
    echo "═══════════════════════════════════════"
    echo "           Ready to Use"
    echo "═══════════════════════════════════════"
    echo ""
    echo "Start Claude Code in tmux:"
    echo "  tmux new -s claude"
    echo "  claude"
    echo ""
    echo "Then run:"
    echo "  lymebridge bridge"
    echo ""
}

run_bridge() {
    local TARGET_SESSION="${1:-}"
    local TARGET_PANE=""

    if [[ -n "$TARGET_SESSION" ]]; then
        # User specified a session name - verify it exists
        if ! tmux has-session -t "$TARGET_SESSION" 2>/dev/null; then
            echo -e "${RED}Error: tmux session '$TARGET_SESSION' not found${NC}"
            echo ""
            echo "Available sessions:"
            tmux list-sessions 2>/dev/null || echo "  (none)"
            exit 1
        fi
        TARGET_PANE="$TARGET_SESSION"
    elif [[ -n "$TMUX_PANE" ]]; then
        # Running inside tmux - use current pane
        TARGET_PANE="$TMUX_PANE"
    else
        # Not in tmux and no session specified
        echo -e "${RED}Error: Not running inside tmux and no session specified${NC}"
        echo ""
        echo "Either run inside tmux, or specify a session:"
        echo "  lymebridge bridge <session-name>"
        echo ""
        echo "Available sessions:"
        tmux list-sessions 2>/dev/null || echo "  (none)"
        exit 1
    fi

    if [[ ! -f "$CONFIG_FILE" ]]; then
        echo -e "${RED}Error: Config not found. Run 'lymebridge setup' first.${NC}"
        exit 1
    fi

    BOT_TOKEN=$(jq -r '.botToken' "$CONFIG_FILE")
    CHAT_ID=$(jq -r '.chatId' "$CONFIG_FILE")

    echo "lymebridge v$VERSION"
    echo ""
    echo "Bridging Telegram ↔ tmux $TARGET_PANE"
    echo "Send messages via Telegram - responses sent back!"
    echo "Press Ctrl+C to stop."
    echo ""

    # Start output monitor in background
    monitor_output "$TARGET_PANE" &
    MONITOR_PID=$!

    trap 'echo ""; echo "Bridge stopped."; kill $MONITOR_PID 2>/dev/null; exit 0' INT

    LAST_UPDATE_ID=0

    while true; do
        RESPONSE=$(curl -s "https://api.telegram.org/bot${BOT_TOKEN}/getUpdates?offset=$((LAST_UPDATE_ID + 1))&timeout=30")

        UPDATES=$(echo "$RESPONSE" | jq -c '.result[]?' 2>/dev/null)

        while IFS= read -r update; do
            [[ -z "$update" ]] && continue

            UPDATE_ID=$(echo "$update" | jq -r '.update_id')
            MSG_CHAT_ID=$(echo "$update" | jq -r '.message.chat.id // empty')
            TEXT=$(echo "$update" | jq -r '.message.text // empty')

            if [[ "$UPDATE_ID" -gt "$LAST_UPDATE_ID" ]]; then
                LAST_UPDATE_ID=$UPDATE_ID
            fi

            [[ "$MSG_CHAT_ID" != "$CHAT_ID" ]] && continue
            [[ -z "$TEXT" ]] && continue
            [[ "$TEXT" == \[* ]] && continue

            echo -e "${YELLOW}[telegram]${NC} ${TEXT:0:50}..."

            tmux send-keys -t "$TARGET_PANE" -l "$TEXT"
            tmux send-keys -t "$TARGET_PANE" Enter

        done <<< "$UPDATES"
    done
}

# Main
check_deps

case "${1:-}" in
    setup)
        run_setup
        ;;
    bridge)
        run_bridge "${2:-}"
        ;;
    version|--version|-v)
        echo "lymebridge v$VERSION"
        ;;
    help|--help|-h|"")
        show_help
        ;;
    *)
        echo "Unknown command: $1"
        show_help
        exit 1
        ;;
esac
